
#####################################################################
#  MCU definition
#####################################################################
[mcu]
##	MCU motor slots
##	[X in MOTOR0] - X Motor
##	[X1 in MOTOR1] - X1 Motor
##	[Y in MOTOR2] - Y Motor
##	[Y1 in MOTOR3] - Y1 Motor
##	[Z in MOTOR4] -  Left
##	[Z1 in MOTOR5] - Rear
##	[Z2 in MOTOR6] - Right
##  [E in MOTOR7] - Extruder

##--------------------------------------------------------------------
## USB: 
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_310040001150334636383920-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_250028001551303531313638-if00
## TTYS0
#serial: /dev/ttyS0
restart_method: command
baud: 2000000

[force_move]
enable_force_move: True

#####################################################################
#  General Printer definition
#####################################################################
[printer]
kinematics: cartesian
max_velocity: 1000
#max_accel: 100000 # change this to 7500 after commissioning
#max_accel_to_decel: 100000
#square_corner_velocity: 80
max_accel: 30000
square_corner_velocity: 15 # start at 8, but then increase once you're sure assembly is sound
max_z_velocity: 50   # may be able to increase to 15 after comissioning.
max_z_accel: 2000


#####################################################################
#  TradRack Beta
#####################################################################
#[include trad_rack_ercf_easybrd.cfg]
#[include trad_rack_optional.cfg]

[include wled.cfg]
#####################################################################
# Pins definitions
#####################################################################
[include pins.cfg]

#####################################################################
#  Stepper Settings
#####################################################################
[include stepper.cfg]

#####################################################################
#  TMC Settings
#####################################################################
[include tmc.cfg]
#####################################################################
#  ERCF Runout Sensor
#####################################################################
# [include runout.cfg]

#####################################################################
#  Extruder & Bed
#####################################################################
#[heaters_extra]
#[pid_calibrate_extra]

[include heater.cfg]

# PID Calibrate Extra


#####################################################################
#  Annex magprobe
#####################################################################
#[include annex_probe.cfg]

#####################################################################
#  Chinese Beacon clone probe
#####################################################################
[include cartographer.cfg]

#####################################################################
#  Fan Control & extra Thermistor
#####################################################################
[include fan.cfg]


#####################################################################
#  Bed Mesh 
#####################################################################
[include bed_mesh.cfg]


#####################################################################
#  Z Tilt
#####################################################################
[include z_tilt.cfg]


#####################################################################
#  Homing Routines
#####################################################################
[include homing.cfg]


#####################################################################
#  Parking Routines
#####################################################################
[include parking.cfg]



#####################################################################
#  Heater Verification (default values)
#####################################################################
[include heater_verify.cfg]


######################################################################
#  Resonance compensation
######################################################################
[include input_shaper.cfg]
[include vibrations.cfg]

#####################################################################
#  Macros
#####################################################################
[include macro.cfg]
[include filament.cfg]

#####################################################################
#  moonraker/mainsail
##################################################################### 
[include webclient.cfg]

#####################################################################
#  LCD Effects plugin
##################################################################### 
#[include caselight.cfg]
#[include lcd_effect.cfg]

#####################################################################
# Runcam Webcam relay
##################################################################### 
#[include runcam.cfg]

#####################################################################
# Exclude objects
##################################################################### 
[include exclude.cfg]


#####################################################################
#  Idle Timeout 
#####################################################################
[idle_timeout]
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      {action_respond_info("POWER: Execute Idle Timeout")}
      TURN_OFF_HEATERS
      M107
      M84
      LIGHTS_OFF
    {% endif %}
  {% endif %}
# 2h timeout
timeout: 14400

[delayed_gcode STARTUP]
initial_duration: 3
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=multistep_filt VALUE=0
  WLED_ON PRESET=1
  {% if 'filament_motion_sensor runout' in printer.configfile.settings %}
    SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
  {% endif %}

#####################################################################
#  Speed Test GCode macros
#####################################################################
[include speedtest.cfg]

[gcode_macro SET_FIRST_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt + 2 %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt + 2%}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}

[gcode_macro SET_NORMAL_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt %}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}


#####################################################################
#  File location of stored varibales
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.208
#*# pid_ki = 1.737
#*# pid_kd = 71.557
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 47.300
#*# pid_ki = 0.542
#*# pid_kd = 1547.432
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3000
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.383224907260716,
#*# 	1.7168659202453616,
#*# 	0.7986827705369834,
#*# 	0.2743547839502284,
#*# 	0.2920312838772159,
#*# 	0.7745433830389092,
#*# 	-0.11792315983328482,
#*# 	-0.833168457294554,
#*# 	0.29301998550408287,
#*# 	0.5181739765292116
#*# model_domain = 3.1251644885987315e-07,3.3288146798500077e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 69.929583
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.015006, 0.020999, 0.011511, 0.002696, -0.004151, 0.004550, -0.012898, -0.001127, -0.021682, -0.005659, -0.015978, -0.010375, -0.027785, -0.021627, -0.028117, -0.043630, -0.047254, -0.052481, -0.063362, -0.070656
#*# 	0.004725, 0.026115, 0.015684, 0.016716, -0.000383, -0.003751, -0.007354, 0.003678, -0.011015, 0.002862, -0.017673, -0.008332, -0.007290, -0.014519, -0.020049, -0.028281, -0.032731, -0.040562, -0.054164, -0.061135
#*# 	0.009478, 0.021764, 0.016086, 0.014106, 0.018365, -0.005630, 0.009758, 0.005038, 0.011194, -0.013611, 0.001693, -0.009012, -0.005238, -0.000488, -0.019681, -0.012609, -0.030669, -0.040937, -0.043720, -0.053115
#*# 	0.000274, 0.016499, 0.016354, 0.016504, 0.010129, 0.003160, -0.001653, 0.013256, -0.000814, -0.001854, -0.000706, -0.005824, 0.000903, -0.000523, -0.004769, -0.014686, -0.020360, -0.029985, -0.038121, -0.042681
#*# 	-0.005530, 0.014004, 0.019609, 0.012772, 0.013294, 0.014589, 0.013257, 0.005537, 0.010084, -0.006044, 0.000306, 0.000209, -0.004216, 0.004134, -0.013094, -0.012467, -0.028639, -0.033142, -0.040771, -0.050702
#*# 	-0.008807, 0.013945, 0.013669, 0.023489, 0.015994, 0.023497, 0.016005, 0.025506, 0.005594, -0.003066, -0.003292, -0.014494, 0.000345, -0.005299, -0.004093, -0.011185, -0.021500, -0.025007, -0.023533, -0.062344
#*# 	-0.003475, 0.008113, 0.016205, 0.029735, 0.037540, 0.031499, 0.046789, 0.032641, 0.016013, 0.005834, -0.007815, -0.009616, -0.011941, 0.003199, -0.015644, -0.012471, -0.022017, -0.030564, -0.037173, -0.046675
#*# 	-0.015445, 0.005087, 0.019200, 0.043017, 0.048021, 0.066307, 0.053571, 0.057420, 0.023685, 0.011872, -0.010484, -0.007553, -0.017934, -0.004796, -0.016742, -0.019882, -0.023434, -0.029433, -0.040512, -0.051925
#*# 	-0.017773, 0.014688, 0.033331, 0.056282, 0.081050, 0.090399, 0.088099, 0.065145, 0.042859, 0.015926, -0.006889, -0.005384, -0.015684, -0.010527, -0.013535, -0.019293, -0.028141, -0.030404, -0.044400, -0.048722
#*# 	-0.026630, 0.007203, 0.034562, 0.051383, 0.083489, 0.102612, 0.091988, 0.062441, 0.050197, 0.003313, 0.001729, -0.022040, -0.019972, -0.012563, -0.016548, -0.023297, -0.030676, -0.035667, -0.043905, -0.057791
#*# 	-0.010120, -0.001466, 0.025131, 0.053654, 0.080714, 0.082768, 0.085723, 0.064196, 0.036953, 0.004228, -0.006061, -0.030048, -0.012746, -0.019278, -0.022790, -0.018989, -0.034194, -0.031224, -0.049456, -0.051639
#*# 	-0.007339, 0.002231, 0.019963, 0.041281, 0.062179, 0.068379, 0.074561, 0.051771, 0.024192, 0.008371, -0.000312, -0.017301, -0.032828, -0.005685, -0.035704, -0.029357, -0.020684, -0.032988, -0.037623, -0.054081
#*# 	-0.018991, 0.000819, 0.016018, 0.024111, 0.043755, 0.043940, 0.045380, 0.037583, 0.018764, -0.003577, -0.011855, -0.025293, -0.016831, -0.012522, -0.016260, -0.013612, -0.026558, -0.025552, -0.035710, -0.047301
#*# 	-0.020204, -0.010262, 0.015831, 0.005884, 0.014899, 0.034341, 0.019024, 0.023811, -0.000921, -0.000802, -0.020169, -0.024170, -0.018038, -0.006127, -0.010054, -0.013479, -0.017752, -0.027010, -0.033564, -0.045793
#*# 	-0.009457, -0.004205, -0.005950, 0.004447, 0.007600, 0.010630, 0.003117, 0.006175, 0.000383, -0.019936, -0.021359, -0.023272, -0.020691, -0.005687, -0.001424, -0.009949, -0.018301, -0.028075, -0.022163, -0.038203
#*# 	-0.017228, -0.004173, -0.010361, -0.009162, 0.002354, -0.002080, -0.010456, 0.002070, -0.012764, -0.030539, -0.028812, -0.027196, -0.018420, -0.017071, -0.017699, -0.013329, -0.018932, -0.019710, -0.030069, -0.035611
#*# 	-0.024248, -0.006448, -0.013085, -0.012516, -0.003343, -0.012911, -0.013644, -0.011865, -0.019675, -0.025253, -0.029274, -0.039301, -0.029203, -0.022815, -0.025267, -0.019846, -0.015111, -0.020603, -0.032917, -0.035355
#*# 	-0.025389, -0.014076, -0.006609, -0.019569, -0.027500, -0.010475, -0.017836, -0.021970, -0.018357, -0.031025, -0.041567, -0.038559, -0.031444, -0.014309, -0.028342, -0.020222, -0.024852, -0.026784, -0.020375, -0.035045
#*# 	-0.010900, -0.016897, -0.011875, -0.013015, -0.027010, -0.022046, -0.023176, -0.027294, -0.029456, -0.026079, -0.039517, -0.036028, -0.033617, -0.026570, -0.031537, -0.026292, -0.029315, -0.019613, -0.024359, -0.029773
#*# 	0.163953, 0.104331, 0.089729, 0.083599, 0.065211, 0.056621, 0.065009, 0.051797, 0.045921, 0.022941, 0.021103, 0.021499, 0.021578, 0.025628, 0.008850, 0.008332, 0.009501, 0.017993, 0.015809, 0.007201
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 15
#*# mesh_y_pps = 15
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 155.0
#*# min_y = 25.0
#*# max_y = 155.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 82.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 85.4
