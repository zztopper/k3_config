
#####################################################################
#  MCU definition
#####################################################################
[mcu]
##	MCU motor slots
##	[X in MOTOR0] - X Motor
##	[X1 in MOTOR1] - X1 Motor
##	[Y in MOTOR2] - Y Motor
##	[Y1 in MOTOR3] - Y1 Motor
##	[Z in MOTOR4] -  Left
##	[Z1 in MOTOR5] - Rear
##	[Z2 in MOTOR6] - Right
##  [E in MOTOR7] - Extruder

##--------------------------------------------------------------------
## USB: 
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_310040001150334636383920-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_250028001551303531313638-if00
## TTYS0
#serial: /dev/ttyS0
restart_method: command
baud: 2000000

[force_move]
enable_force_move: True

#####################################################################
#  General Printer definition
#####################################################################
[printer]
kinematics: cartesian
max_velocity: 1000
#max_accel: 100000 # change this to 7500 after commissioning
#max_accel_to_decel: 100000
#square_corner_velocity: 80
max_accel: 30000
square_corner_velocity: 15 # start at 8, but then increase once you're sure assembly is sound
max_z_velocity: 50   # may be able to increase to 15 after comissioning.
max_z_accel: 2000


#####################################################################
#  TradRack Beta
#####################################################################
#[include trad_rack_ercf_easybrd.cfg]
#[include trad_rack_optional.cfg]

[include wled.cfg]
#####################################################################
# Pins definitions
#####################################################################
[include pins.cfg]

#####################################################################
#  Stepper Settings
#####################################################################
[include stepper.cfg]

#####################################################################
#  TMC Settings
#####################################################################
[include tmc.cfg]
#####################################################################
#  ERCF Runout Sensor
#####################################################################
[include runout.cfg]

#####################################################################
#  Extruder & Bed
#####################################################################
#[heaters_extra]
#[pid_calibrate_extra]

[include heater.cfg]

# PID Calibrate Extra


#####################################################################
#  Annex magprobe
#####################################################################
#[include annex_probe.cfg]

#####################################################################
#  Chinese Beacon clone probe
#####################################################################
[include cartographer.cfg]

#####################################################################
#  Fan Control & extra Thermistor
#####################################################################
[include fan.cfg]


#####################################################################
#  Bed Mesh 
#####################################################################
[include bed_mesh.cfg]


#####################################################################
#  Z Tilt
#####################################################################
[include z_tilt.cfg]


#####################################################################
#  Homing Routines
#####################################################################
[include homing.cfg]


#####################################################################
#  Parking Routines
#####################################################################
[include parking.cfg]



#####################################################################
#  Heater Verification (default values)
#####################################################################
[include heater_verify.cfg]


######################################################################
#  Resonance compensation
######################################################################
[include input_shaper.cfg]
[include vibrations.cfg]

#####################################################################
#  Macros
#####################################################################
[include macro.cfg]
[include filament.cfg]

#####################################################################
#  moonraker/mainsail
##################################################################### 
[include webclient.cfg]

#####################################################################
#  LCD Effects plugin
##################################################################### 
#[include caselight.cfg]
#[include lcd_effect.cfg]

#####################################################################
# Runcam Webcam relay
##################################################################### 
#[include runcam.cfg]

#####################################################################
# Exclude objects
##################################################################### 
[include exclude.cfg]


# --- POWER OFF через Moonraker (device = имя секции [power ...] в moonraker.conf) ---
[gcode_macro POWER_OFF_K3]
description: Turn off printer mains power via Moonraker power device k3_power
gcode:
  {action_respond_info("POWER: switching OFF k3_power")}
  {action_call_remote_method("set_device_power", device="k3_power", state="off")}



# --- Отложенное выключение питания (второй шаг) ---
[delayed_gcode K3_AUTO_POWEROFF]
initial_duration: 0
gcode:
  # Выключаемся ТОЛЬКО если принтер всё ещё реально простаивает
  {% if printer.idle_timeout.state == "Idle" and printer.print_stats.state|lower != "printing" %}
    {% set e = printer.extruder.temperature|float %}
    {% set b = (printer.heater_bed.temperature|float) if (printer.heater_bed is defined) else 0.0 %}

    # На всякий случай ждём, пока остынет (например, ниже 50C), потом выключаем питание
    {% if e < 50 and b < 50 %}
      POWER_OFF_K3
    {% else %}
      {action_respond_info("POWER: still warm (E=%.1fC, B=%.1fC). Recheck in 10 min" % (e, b))}
      UPDATE_DELAYED_GCODE ID=K3_AUTO_POWEROFF DURATION=600
    {% endif %}
  {% endif %}

#####################################################################
#  Idle Timeout 
#####################################################################

# --- Первый шаг: через 2 часа простоя уходим в "холодное" состояние и запускаем таймер на power off ---
[idle_timeout]
timeout: 7200   # 2 часа (у тебя было 14400 = 4 часа)
gcode:
  {% if printer.webhooks.state|lower == 'ready' and printer.pause_resume.is_paused|lower == 'false' %}
    {action_respond_info("POWER: Idle 2h -> cool down now; power off in 2h if still idle")}
    TURN_OFF_HEATERS
    M107
    M84
    LIGHTS_OFF

    # Запланировать выключение питания ещё через 2 часа
    UPDATE_DELAYED_GCODE ID=K3_AUTO_POWEROFF DURATION=7200
  {% endif %}



[delayed_gcode STARTUP]
initial_duration: 3
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=multistep_filt VALUE=0
  WLED_ON PRESET=1
  {% if 'filament_motion_sensor runout' in printer.configfile.settings %}
    SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
  {% endif %}

#####################################################################
#  Speed Test GCode macros
#####################################################################
[include speedtest.cfg]

[gcode_macro SET_FIRST_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt + 2 %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt + 2%}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}

[gcode_macro SET_NORMAL_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt %}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}


#####################################################################
#  File location of stored varibales
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.332
#*# pid_ki = 1.002
#*# pid_kd = 74.961
#*# pid_version = 1
#*# pid_target = 260.00
#*# pid_tolerance = 0.0200
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 47.300
#*# pid_ki = 0.542
#*# pid_kd = 1547.432
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 82.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 85.4
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.314458508802295,1.7727652949148527,0.833464059332589,0.3606861986924136,0.5730104498306948,0.9179382374686116,-0.4949321352611039,-1.103787316319318,0.5730468363694317,0.75248754999722
#*# domain = 3.1055643956040864e-07,3.331857679179203e-07
#*# z_offset = 0
#*# reference_temperature = -63.64
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.019815, 0.001214, 0.006939, 0.013487, 0.016844, 0.008623, 0.001879, -0.003011, 0.010306, 0.006939, -0.008091, 0.008623, -0.003189, -0.009788, -0.003011, -0.014708, -0.013186, -0.019815, -0.011486, -0.011486, -0.031604, -0.036751, -0.045182, -0.041733, -0.009788, -0.033320, -0.046905, -0.048633, -0.046045, -0.056242
#*# 	  -0.005554, 0.002722, 0.020195, 0.013667, 0.020195, 0.013667, 0.015166, 0.001879, 0.003567, 0.011987, -0.001497, -0.003011, 0.010306, 0.010126, 0.006939, 0.003567, 0.003567, -0.001319, -0.019815, -0.004704, -0.001497, -0.023229, -0.004704, -0.008091, -0.028357, -0.035035, -0.040015, -0.050451, -0.036751, -0.034088
#*# 	  -0.036785, 0.021868, 0.002060, 0.039834, 0.028368, 0.008623, 0.023358, 0.028368, 0.021868, 0.021868, 0.016844, 0.017023, 0.020195, 0.015166, 0.016844, 0.026699, 0.010306, 0.026699, -0.003011, -0.004704, 0.011987, -0.008091, 0.000190, -0.013007, -0.009610, 0.005254, -0.031604, -0.033320, -0.025792, -0.036751
#*# 	  0.000278, 0.011806, 0.021868, 0.011807, 0.011987, 0.013667, -0.001319, 0.017023, 0.026699, 0.016844, 0.010306, 0.003567, 0.003567, 0.015166, 0.006939, 0.020195, 0.000190, 0.013487, 0.000371, -0.006398, 0.003567, 0.003567, 0.001879, -0.008091, -0.006398, -0.008091, -0.035036, -0.033320, -0.024853, -0.035099
#*# 	  -0.006399, 0.017680, 0.018520, 0.031701, 0.028550, 0.011987, 0.021868, 0.030217, 0.020195, 0.020195, 0.030035, 0.023541, 0.023541, 0.011807, 0.013667, 0.013667, 0.031701, 0.021868, 0.031701, 0.016844, 0.010306, 0.011807, 0.010126, -0.006398, 0.017023, -0.004704, 0.003567, -0.032553, -0.024759, -0.035036
#*# 	  0.001969, 0.007781, 0.023541, 0.013487, 0.021868, 0.008623, 0.011807, 0.008623, 0.001879, 0.016844, 0.010126, 0.015166, 0.016844, 0.010306, 0.023541, 0.003567, 0.026699, 0.021868, 0.008443, 0.011987, 0.002060, 0.006939, 0.021868, 0.000190, -0.008091, -0.011486, -0.031711, -0.033320, -0.027501, -0.024947
#*# 	  -0.018118, 0.021868, 0.003652, 0.030217, 0.021686, 0.010306, 0.017023, 0.021868, 0.030035, 0.020195, 0.038352, 0.021868, 0.026881, 0.044805, 0.030217, 0.030035, 0.033366, 0.023358, 0.038174, 0.043330, 0.040011, 0.026699, 0.011987, 0.011987, 0.006939, 0.010306, -0.009788, -0.023050, -0.019058, -0.025614
#*# 	  0.004409, 0.013577, 0.030035, 0.015166, 0.013667, 0.013667, 0.000190, 0.005254, 0.006939, 0.001879, 0.025212, 0.013667, 0.015346, 0.030217, 0.020015, 0.006939, 0.020195, 0.018520, 0.017023, 0.021686, 0.003567, 0.011807, 0.013667, 0.010306, -0.009788, -0.014887, -0.024759, -0.038294, -0.021524, -0.009715
#*# 	  -0.018102, 0.012736, 0.002801, 0.026699, 0.013667, -0.001319, 0.018520, 0.023541, 0.026699, 0.031701, 0.020195, 0.033366, 0.026881, 0.031701, 0.034851, 0.020195, 0.026881, 0.038352, 0.023541, 0.043330, 0.018520, 0.006939, 0.028368, 0.006939, -0.001319, 0.005254, -0.013186, -0.026469, -0.024084, -0.027413
#*# 	  -0.002254, 0.006096, 0.023444, 0.010306, 0.023541, 0.018520, 0.006939, 0.008623, 0.008623, 0.003567, 0.018520, 0.023541, 0.005254, 0.026699, 0.015166, 0.020195, 0.010306, 0.010306, 0.001879, 0.003567, 0.001879, 0.010126, 0.002060, -0.003011, -0.009788, -0.021522, -0.024759, -0.029890, -0.028271, -0.042743
#*# 	  -0.017273, 0.015250, -0.011308, 0.023541, 0.005254, -0.008091, 0.010306, 0.023358, 0.018699, 0.018520, 0.025029, 0.021686, 0.018520, 0.026699, 0.025029, 0.006939, 0.015346, 0.020195, 0.018520, 0.028550, 0.025212, 0.026881, 0.017023, 0.021868, 0.015166, 0.003567, -0.009788, -0.026645, -0.022378, -0.028179
#*# 	  -0.008939, -0.001410, 0.015166, 0.002060, 0.008623, 0.005254, 0.003567, 0.001879, -0.004882, 0.010306, 0.000190, 0.008443, 0.001879, 0.015166, 0.018520, 0.005254, 0.023541, -0.008091, -0.011308, -0.001319, 0.006939, 0.003748, 0.003567, -0.006398, -0.016410, -0.013186, -0.028180, -0.027413, -0.024759, -0.020766
#*# 	  -0.045181, -0.002260, -0.011308, 0.008623, -0.004704, -0.006576, 0.020195, 0.005254, 0.011987, 0.026699, 0.013487, 0.011987, 0.018520, -0.003011, 0.030035, 0.013667, 0.006939, 0.015166, -0.004704, 0.036691, 0.031701, 0.013487, 0.013487, 0.011987, 0.005254, 0.003567, -0.009788, -0.021343, -0.020678, -0.027501
#*# 	  -0.024183, -0.010650, 0.013667, -0.007913, -0.009788, -0.006398, -0.016410, -0.008091, -0.007913, -0.011486, -0.006398, -0.001319, -0.001319, 0.002060, 0.000371, -0.004882, -0.003189, -0.003011, -0.009610, -0.013186, -0.013186, -0.001497, -0.006398, -0.014708, -0.014887, -0.029890, -0.023050, -0.040192, -0.026573, -0.052941
#*# 	  -0.030011, -0.013097, -0.013186, -0.004704, -0.001319, -0.019994, -0.004704, 0.000190, 0.011807, 0.003567, 0.001879, 0.018520, 0.011987, -0.001319, 0.008443, 0.005254, 0.005254, 0.000190, 0.005254, 0.000371, 0.006939, 0.011807, 0.003567, 0.006939, -0.001319, -0.009788, -0.019815, -0.026647, -0.026469, -0.031604
#*# 	  -0.027501, -0.017262, 0.006939, -0.008091, -0.006398, -0.003189, -0.021522, -0.003011, -0.003011, -0.014708, -0.009788, 0.000371, -0.008091, -0.003011, -0.001497, -0.011486, -0.021522, -0.016410, -0.009610, -0.019815, -0.019815, -0.026469, -0.009610, -0.021522, -0.026469, -0.033320, -0.032463, -0.048633, -0.031605, -0.037615
#*# 	  -0.041955, -0.021522, -0.008098, -0.004704, -0.003011, -0.014708, 0.003748, 0.006939, 0.013487, 0.003567, -0.001319, 0.003567, 0.005254, 0.003748, 0.010306, 0.003567, 0.006939, -0.004704, -0.013007, 0.006939, 0.006939, 0.001879, -0.004704, -0.008091, 0.000190, -0.018289, -0.014887, -0.027325, -0.021527, -0.028269
#*# 	  -0.012249, -0.003954, 0.009374, 0.001879, -0.006398, 0.008623, -0.009610, -0.016410, 0.000371, -0.014708, 0.000371, -0.004704, 0.015166, 0.003748, -0.004704, -0.001497, 0.003567, 0.010126, 0.001879, -0.008091, -0.007913, 0.000190, -0.007913, -0.011308, -0.018110, -0.033320, -0.033320, -0.040192, -0.034088, -0.046133
#*# 	  -0.029261, 0.001785, 0.001879, 0.015166, -0.001319, -0.003011, 0.011807, 0.013487, 0.013667, 0.016844, 0.016844, 0.020195, 0.005254, 0.020195, 0.025212, 0.008443, 0.020195, 0.021868, 0.008443, 0.021868, -0.003189, 0.016844, 0.020195, 0.008623, -0.016410, -0.008091, -0.011486, -0.036751, -0.027417, -0.029990
#*# 	  -0.014708, -0.003011, 0.020194, 0.005254, 0.016844, 0.011987, -0.014708, -0.018289, 0.003567, 0.015166, 0.008623, -0.009788, 0.010306, 0.000371, 0.018520, -0.001497, 0.006939, 0.016844, -0.001319, -0.014887, 0.000190, -0.006398, 0.003567, -0.011486, -0.009788, -0.026645, -0.021522, -0.035036, -0.027325, -0.026567
#*# 	  -0.014717, 0.017678, -0.003189, 0.025212, 0.008443, -0.004704, 0.001879, 0.008623, -0.001497, 0.010126, 0.008623, 0.016844, 0.008623, 0.000371, 0.008623, -0.003011, 0.011807, -0.004704, -0.006398, 0.013667, -0.001319, 0.003748, 0.000371, 0.020195, 0.003567, -0.016410, -0.009703, -0.026469, -0.018110, -0.022286
#*# 	  -0.015559, 0.000278, 0.020195, 0.006939, 0.003567, -0.004704, -0.006398, 0.001879, 0.000371, 0.001879, -0.008091, 0.008443, 0.005254, 0.000371, 0.003567, -0.009788, 0.006939, -0.008091, 0.015346, 0.005434, -0.003011, 0.000371, 0.002060, 0.001879, -0.011486, -0.018110, -0.029890, -0.033414, -0.028180, -0.024938
#*# 	  -0.025723, -0.001412, 0.001879, 0.015346, 0.001879, -0.001319, 0.002060, -0.004704, -0.001497, 0.015166, -0.001319, 0.013487, 0.000190, 0.003748, 0.005254, -0.001319, 0.023358, 0.030035, 0.010126, 0.000371, 0.016844, 0.030035, 0.011807, 0.018520, -0.007913, 0.002060, -0.018110, -0.018110, -0.024938, -0.033320
#*# 	  -0.010637, 0.001035, 0.016844, 0.008623, -0.006576, 0.006939, -0.021343, -0.016410, -0.011486, -0.009788, 0.001879, -0.016410, -0.004704, -0.023229, -0.023050, -0.021522, -0.008091, 0.016844, -0.019815, 0.001879, -0.008091, -0.003189, -0.008091, -0.014887, -0.018110, -0.011308, -0.030070, -0.031698, -0.029143, -0.040092
#*# 	  -0.019959, 0.003657, -0.004704, 0.010126, -0.004704, -0.013007, -0.011486, -0.009788, 0.008623, -0.016586, 0.005254, -0.013186, -0.004704, 0.003567, -0.009788, 0.015166, -0.013186, -0.003011, -0.011486, 0.002060, 0.013487, 0.005254, 0.005254, -0.004704, -0.014708, -0.009703, -0.019815, -0.027325, -0.026645, -0.029982
#*# 	  -0.018115, -0.007246, 0.011987, 0.001879, -0.006398, -0.011308, -0.019815, -0.011308, -0.014887, -0.018289, -0.013007, -0.021522, -0.019815, -0.006398, -0.011486, -0.023229, -0.033320, -0.014887, -0.011486, -0.013007, -0.006398, -0.008091, -0.014708, -0.021522, -0.019815, -0.024938, -0.033496, -0.033320, -0.029987, -0.035990
#*# 	  -0.024865, -0.016410, 0.003565, -0.001319, -0.003948, -0.014887, -0.013186, -0.003011, -0.014887, 0.013667, 0.005434, -0.006398, -0.018289, 0.010306, -0.013186, -0.028357, -0.001319, -0.024759, -0.021522, -0.019815, -0.009788, -0.014708, -0.011486, -0.004704, 0.005254, -0.026469, -0.011308, -0.036751, -0.023995, -0.028269
#*# 	  -0.020668, -0.009788, 0.003748, -0.004704, -0.014708, -0.013186, -0.016410, -0.013186, -0.013186, -0.016410, -0.011308, -0.011308, -0.018110, -0.019815, -0.031604, -0.021522, -0.026645, -0.023229, -0.016410, -0.021522, -0.018110, -0.013007, -0.016410, -0.016410, -0.024938, -0.018110, -0.023229, -0.028357, -0.026647, -0.036600
#*# 	  -0.030774, -0.008942, 0.003748, -0.006398, -0.016586, -0.009610, -0.018110, -0.011486, -0.019815, -0.003189, 0.010306, 0.000190, -0.016410, -0.006398, 0.000190, -0.018289, 0.010306, 0.005254, 0.005254, -0.019815, -0.004704, -0.016586, -0.021522, -0.018110, -0.003011, -0.019815, -0.008091, -0.029890, -0.015648, -0.021524
#*# 	  -0.023229, -0.008939, 0.006085, 0.000190, -0.026645, -0.021522, -0.008091, -0.013007, -0.004704, -0.009788, 0.008623, -0.008091, 0.006939, -0.013186, -0.028180, -0.021522, -0.036751, -0.014887, -0.029890, -0.016586, -0.011308, -0.016410, -0.018110, -0.003011, -0.009610, -0.023229, -0.024759, -0.021522, -0.019815, -0.011486
#*# min_x = 25.0
#*# min_y = 25.0
#*# max_x = 155.0
#*# max_y = 155.0
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer touch_model default]
#*# threshold = 2717
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.1.0
