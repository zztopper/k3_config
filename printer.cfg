
#####################################################################
#  MCU definition
#####################################################################
[mcu]
##	MCU motor slots
##	[X in MOTOR0] - X Motor
##	[X1 in MOTOR1] - X1 Motor
##	[Y in MOTOR2] - Y Motor
##	[Y1 in MOTOR3] - Y1 Motor
##	[Z in MOTOR4] -  Left
##	[Z1 in MOTOR5] - Rear
##	[Z2 in MOTOR6] - Right
##  [E in MOTOR7] - Extruder

##--------------------------------------------------------------------
## USB: 
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_310040001150334636383920-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_250028001551303531313638-if00
## TTYS0
#serial: /dev/ttyS0
restart_method: command
baud: 2000000

[force_move]
enable_force_move: True

#####################################################################
#  General Printer definition
#####################################################################
[printer]
kinematics: cartesian
max_velocity: 1000
#max_accel: 100000 # change this to 7500 after commissioning
#max_accel_to_decel: 100000
#square_corner_velocity: 80
max_accel: 30000
square_corner_velocity: 15 # start at 8, but then increase once you're sure assembly is sound
max_z_velocity: 50   # may be able to increase to 15 after comissioning.
max_z_accel: 2000


#####################################################################
#  TradRack Beta
#####################################################################
#[include trad_rack_ercf_easybrd.cfg]
#[include trad_rack_optional.cfg]

[include wled.cfg]
#####################################################################
# Pins definitions
#####################################################################
[include pins.cfg]

#####################################################################
#  Stepper Settings
#####################################################################
[include stepper.cfg]

#####################################################################
#  TMC Settings
#####################################################################
[include tmc.cfg]
#####################################################################
#  ERCF Runout Sensor
#####################################################################
[include runout.cfg]

#####################################################################
#  Extruder & Bed
#####################################################################
#[heaters_extra]
#[pid_calibrate_extra]

[include heater.cfg]

# PID Calibrate Extra


#####################################################################
#  Annex magprobe
#####################################################################
#[include annex_probe.cfg]

#####################################################################
#  Chinese Beacon clone probe
#####################################################################
[include cartographer.cfg]

#####################################################################
#  Fan Control & extra Thermistor
#####################################################################
[include fan.cfg]


#####################################################################
#  Bed Mesh 
#####################################################################
[include bed_mesh.cfg]


#####################################################################
#  Z Tilt
#####################################################################
[include z_tilt.cfg]


#####################################################################
#  Homing Routines
#####################################################################
[include homing.cfg]


#####################################################################
#  Parking Routines
#####################################################################
[include parking.cfg]



#####################################################################
#  Heater Verification (default values)
#####################################################################
[include heater_verify.cfg]


######################################################################
#  Resonance compensation
######################################################################
[include input_shaper.cfg]
[include vibrations.cfg]

#####################################################################
#  Macros
#####################################################################
[include macro.cfg]
[include filament.cfg]

#####################################################################
#  moonraker/mainsail
##################################################################### 
[include webclient.cfg]

#####################################################################
#  LCD Effects plugin
##################################################################### 
#[include caselight.cfg]
#[include lcd_effect.cfg]

#####################################################################
# Runcam Webcam relay
##################################################################### 
#[include runcam.cfg]

#####################################################################
# Exclude objects
##################################################################### 
[include exclude.cfg]


# --- POWER OFF через Moonraker (device = имя секции [power ...] в moonraker.conf) ---
[gcode_macro POWER_OFF_K3]
description: Turn off printer mains power via Moonraker power device k3_power
gcode:
  {action_respond_info("POWER: switching OFF k3_power")}
  {action_call_remote_method("set_device_power", device="k3_power", state="off")}



# --- Отложенное выключение питания (второй шаг) ---
[delayed_gcode K3_AUTO_POWEROFF]
initial_duration: 0
gcode:
  # Выключаемся ТОЛЬКО если принтер всё ещё реально простаивает
  {% if printer.idle_timeout.state == "Idle" and printer.print_stats.state|lower != "printing" %}
    {% set e = printer.extruder.temperature|float %}
    {% set b = (printer.heater_bed.temperature|float) if (printer.heater_bed is defined) else 0.0 %}

    # На всякий случай ждём, пока остынет (например, ниже 50C), потом выключаем питание
    {% if e < 50 and b < 50 %}
      POWER_OFF_K3
    {% else %}
      {action_respond_info("POWER: still warm (E=%.1fC, B=%.1fC). Recheck in 10 min" % (e, b))}
      UPDATE_DELAYED_GCODE ID=K3_AUTO_POWEROFF DURATION=600
    {% endif %}
  {% endif %}

#####################################################################
#  Idle Timeout 
#####################################################################

# --- Первый шаг: через 2 часа простоя уходим в "холодное" состояние и запускаем таймер на power off ---
[idle_timeout]
timeout: 7200   # 2 часа (у тебя было 14400 = 4 часа)
gcode:
  {% if printer.webhooks.state|lower == 'ready' and printer.pause_resume.is_paused|lower == 'false' %}
    {action_respond_info("POWER: Idle 2h -> cool down now; power off in 2h if still idle")}
    TURN_OFF_HEATERS
    M107
    M84
    LIGHTS_OFF

    # Запланировать выключение питания ещё через 2 часа
    UPDATE_DELAYED_GCODE ID=K3_AUTO_POWEROFF DURATION=7200
  {% endif %}



[delayed_gcode STARTUP]
initial_duration: 3
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=multistep_filt VALUE=0
  WLED_ON PRESET=1
  {% if 'filament_motion_sensor runout' in printer.configfile.settings %}
    SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
  {% endif %}

#####################################################################
#  Speed Test GCode macros
#####################################################################
[include speedtest.cfg]

[gcode_macro SET_FIRST_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt + 2 %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt + 2%}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}

[gcode_macro SET_NORMAL_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt %}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}


#####################################################################
#  File location of stored varibales
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.332
#*# pid_ki = 1.002
#*# pid_kd = 74.961
#*# pid_version = 1
#*# pid_target = 260.00
#*# pid_tolerance = 0.0200
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 47.300
#*# pid_ki = 0.542
#*# pid_kd = 1547.432
#*#
#*# [scanner]
#*# mode = scan
#*#
#*# [scanner model default]
#*# model_coef = 1.2680427005900434,
#*# 	1.6867360823843804,
#*# 	0.735539481128375,
#*# 	0.2697653714089986,
#*# 	0.5681657635980129,
#*# 	0.9790894697561997,
#*# 	-0.5071073974758741,
#*# 	-1.21141262142833,
#*# 	0.4847770964578287,
#*# 	0.7263243044028517
#*# model_domain = 3.097722107935441e-07,3.326157217241493e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 64.358046
#*# model_offset = -0.07500
#*# model_mode = scan
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.028756, 0.050662, 0.056329, 0.042132, 0.040699, 0.034789, 0.029284, 0.026051, 0.031569, 0.030626, 0.025675, 0.025234, 0.024299, 0.022066, 0.021027, 0.019656, 0.021054, 0.020149, 0.012597, 0.010312, 0.006811, 0.002355, -0.002348, -0.005843, -0.008714, -0.016659, -0.014079, -0.038107, -0.028057, -0.035661
#*# 	  0.039755, 0.055563, 0.053062, 0.050530, 0.043457, 0.036772, 0.036430, 0.038227, 0.031539, 0.031372, 0.031273, 0.030715, 0.030163, 0.028879, 0.029884, 0.027579, 0.023413, 0.023059, 0.016345, 0.014905, 0.017514, 0.009975, 0.006285, 0.004223, -0.001893, -0.009647, -0.012765, -0.012904, -0.014572, -0.034707
#*# 	  0.035761, 0.058642, 0.050773, 0.055847, 0.049147, 0.039889, 0.041685, 0.038756, 0.035682, 0.037290, 0.038872, 0.034775, 0.036768, 0.035328, 0.032060, 0.034007, 0.033292, 0.033739, 0.027953, 0.024569, 0.022988, 0.018981, 0.013332, 0.008337, 0.002841, -0.002580, -0.005680, -0.010120, -0.009989, -0.028810
#*# 	  0.043817, 0.053289, 0.052674, 0.051473, 0.041002, 0.038207, 0.041117, 0.035962, 0.032980, 0.037292, 0.033662, 0.032277, 0.034505, 0.034842, 0.034012, 0.032587, 0.032006, 0.031919, 0.028923, 0.024654, 0.024937, 0.019150, 0.015956, 0.012909, 0.005690, -0.001155, -0.004750, -0.024029, -0.017318, -0.023111
#*# 	  0.038536, 0.049283, 0.042015, 0.049821, 0.043282, 0.036156, 0.039969, 0.033951, 0.031656, 0.036024, 0.035249, 0.032481, 0.030363, 0.031534, 0.033486, 0.032340, 0.033864, 0.036508, 0.033365, 0.032826, 0.028700, 0.023328, 0.019228, 0.013421, 0.009477, 0.001475, -0.003425, -0.008086, -0.018464, -0.017856
#*# 	  0.035104, 0.050792, 0.057681, 0.046963, 0.040508, 0.034588, 0.036649, 0.034208, 0.031226, 0.036121, 0.032845, 0.033366, 0.031635, 0.031100, 0.031542, 0.031511, 0.034510, 0.037722, 0.032549, 0.033903, 0.032987, 0.026394, 0.024300, 0.020024, 0.010382, 0.004051, -0.001122, -0.008710, -0.015733, -0.019462
#*# 	  0.024909, 0.053646, 0.042458, 0.041632, 0.039244, 0.031032, 0.035874, 0.033235, 0.027668, 0.032809, 0.032951, 0.029138, 0.027837, 0.030013, 0.029176, 0.029408, 0.028724, 0.033555, 0.031169, 0.030790, 0.031415, 0.028666, 0.022896, 0.015998, 0.009036, 0.001110, -0.007716, -0.008893, -0.014464, -0.018801
#*# 	  0.015524, 0.051252, 0.044770, 0.041562, 0.037590, 0.033374, 0.034312, 0.029245, 0.029093, 0.031679, 0.030593, 0.029011, 0.029903, 0.029234, 0.030119, 0.030083, 0.028163, 0.033369, 0.032489, 0.032663, 0.035040, 0.029250, 0.026612, 0.018889, 0.011591, 0.004563, -0.003042, -0.007851, -0.015585, -0.023586
#*# 	  0.030784, 0.040302, 0.041875, 0.039916, 0.034112, 0.028627, 0.032847, 0.031500, 0.027548, 0.031248, 0.033331, 0.031796, 0.029416, 0.030811, 0.027449, 0.028823, 0.028306, 0.030829, 0.030563, 0.030601, 0.032645, 0.029233, 0.023098, 0.017460, 0.008322, 0.002707, -0.006607, -0.012786, -0.019105, -0.020012
#*# 	  0.024027, 0.040162, 0.033854, 0.036055, 0.026596, 0.024327, 0.027686, 0.023931, 0.025145, 0.028080, 0.028331, 0.029698, 0.024139, 0.026841, 0.029181, 0.024366, 0.022043, 0.028090, 0.027939, 0.024383, 0.029368, 0.024132, 0.021408, 0.015357, 0.007501, -0.000946, -0.007044, -0.011892, -0.030940, -0.027220
#*# 	  0.026588, 0.022943, 0.028915, 0.032915, 0.024493, 0.020845, 0.022580, 0.021774, 0.020330, 0.023643, 0.029500, 0.026410, 0.023501, 0.023483, 0.023852, 0.019520, 0.022524, 0.023873, 0.019860, 0.022587, 0.025027, 0.020635, 0.016979, 0.011463, 0.004138, -0.006078, -0.011258, -0.014463, -0.019472, -0.023200
#*# 	  0.008235, 0.026453, 0.025298, 0.028283, 0.019702, 0.017722, 0.020758, 0.019235, 0.017281, 0.015036, 0.019972, 0.020160, 0.015878, 0.018104, 0.021185, 0.018993, 0.018461, 0.019597, 0.019568, 0.019576, 0.021057, 0.017808, 0.011751, 0.008038, 0.003834, -0.002868, -0.011873, -0.017434, -0.011787, -0.035378
#*# 	  0.000533, 0.021310, 0.019570, 0.021230, 0.017524, 0.011981, 0.016076, 0.014928, 0.013576, 0.014121, 0.019708, 0.018221, 0.015809, 0.015813, 0.019080, 0.017087, 0.015819, 0.016809, 0.015662, 0.013560, 0.016640, 0.015586, 0.009289, 0.006372, 0.001332, -0.009716, -0.017003, -0.016907, -0.015608, -0.031917
#*# 	  0.001115, 0.016744, 0.018204, 0.016959, 0.010102, 0.010000, 0.011724, 0.006382, 0.006756, 0.006051, 0.007198, 0.012602, 0.006733, 0.011055, 0.015266, 0.011334, 0.008220, 0.008716, 0.008324, 0.009032, 0.008745, 0.009375, 0.006463, 0.002050, -0.004858, -0.007496, -0.014681, -0.031824, -0.024728, -0.029725
#*# 	  -0.003636, 0.002957, 0.010993, 0.011728, 0.005973, 0.003301, 0.008543, 0.002091, 0.002461, 0.005666, 0.006288, 0.003855, 0.002785, 0.002338, 0.004242, 0.003918, 0.002095, 0.001777, -0.002672, -0.000537, 0.001774, 0.000897, -0.003879, -0.004817, -0.010904, -0.012193, -0.016054, -0.015795, -0.028593, -0.033332
#*# 	  -0.003060, 0.014260, 0.014043, 0.014218, 0.009928, 0.004913, 0.008203, 0.005635, 0.003672, 0.002777, 0.004746, 0.007253, 0.004792, 0.003520, 0.004847, 0.004150, 0.001627, 0.002234, 0.001805, -0.001807, 0.003135, 0.002678, -0.004796, -0.004750, -0.009186, -0.014942, -0.017336, -0.019308, -0.032434, -0.023721
#*# 	  -0.015441, 0.020486, 0.012413, 0.013436, 0.009704, 0.007581, 0.007179, 0.007877, 0.005587, 0.008217, 0.008341, 0.005586, 0.007284, 0.006798, 0.002090, 0.002019, -0.000540, 0.000757, -0.001404, -0.003344, -0.000217, -0.000912, -0.000741, -0.004165, -0.010268, -0.013481, -0.018595, -0.020069, -0.027721, -0.029068
#*# 	  -0.004953, 0.012632, 0.014447, 0.014354, 0.010232, 0.008202, 0.008419, 0.008906, 0.006186, 0.004106, 0.007724, 0.008229, 0.006174, 0.002483, 0.003475, 0.003735, -0.001111, -0.000583, -0.004382, -0.006434, 0.000210, 0.001343, -0.005064, -0.006611, -0.010085, -0.012695, -0.016372, -0.018231, -0.015515, -0.028491
#*# 	  -0.003152, 0.009847, 0.017930, 0.017103, 0.014424, 0.005219, 0.013202, 0.015033, 0.005908, 0.005801, 0.007809, 0.005423, 0.008946, 0.005443, 0.005858, 0.003356, 0.002492, -0.002169, -0.004443, -0.001904, -0.005290, -0.002889, -0.000304, -0.008077, -0.006772, -0.013078, -0.017620, -0.019994, -0.025631, -0.029670
#*# 	  0.005659, 0.019642, 0.021494, 0.015994, 0.012363, 0.008438, 0.011687, 0.009142, 0.008931, 0.008479, 0.009189, 0.011550, 0.002585, 0.009691, 0.009873, 0.003705, -0.000253, -0.000366, 0.001232, 0.000240, 0.004257, 0.003039, 0.000837, -0.005381, -0.008634, -0.008690, -0.014217, -0.015087, -0.025581, -0.025751
#*# 	  0.008323, 0.001975, 0.014786, 0.019827, 0.013506, 0.005522, 0.012776, 0.008030, 0.008406, 0.011311, 0.012101, 0.007041, 0.006128, 0.008068, 0.007427, 0.002451, 0.001123, 0.002272, 0.000878, 0.000618, 0.007596, 0.007191, 0.005045, -0.004721, -0.006427, -0.010310, -0.014504, -0.014501, -0.025835, -0.027652
#*# 	  -0.003416, 0.015600, 0.016420, 0.021093, 0.010783, 0.008194, 0.009393, 0.006447, 0.011672, 0.004407, 0.011786, 0.012906, 0.003608, 0.010095, -0.001989, 0.005428, 0.006003, 0.003257, 0.003616, 0.003846, 0.007465, 0.004214, 0.002805, -0.002774, -0.006435, -0.009206, -0.014112, -0.016952, -0.017027, -0.031064
#*# 	  -0.001854, 0.019584, 0.014276, 0.020062, 0.006476, 0.005578, 0.009603, 0.006871, 0.005323, 0.004844, 0.008702, 0.008857, 0.004939, 0.000306, -0.005753, 0.005108, 0.002994, 0.001060, 0.002604, 0.002876, 0.006373, 0.006879, 0.004454, 0.001524, -0.004164, -0.009172, -0.017483, -0.017134, -0.023435, -0.023293
#*# 	  -0.012649, 0.012696, 0.009764, 0.014842, 0.002901, 0.007967, 0.003482, 0.009086, 0.001917, 0.005329, 0.005522, -0.001557, 0.011169, -0.003093, -0.006817, -0.004995, -0.004237, -0.006916, -0.003150, 0.007778, 0.002033, 0.000741, -0.001738, -0.006239, -0.008320, -0.011035, -0.019428, -0.019923, -0.029049, -0.028007
#*# 	  -0.003037, 0.014093, 0.006988, 0.012190, 0.008110, 0.000558, -0.001564, -0.001553, 0.003929, 0.007769, 0.000169, -0.007675, -0.000210, -0.006610, -0.007944, -0.006286, -0.008382, -0.005853, -0.013166, -0.003226, -0.004601, -0.001051, -0.006417, -0.013780, -0.013388, -0.020996, -0.021911, -0.022803, -0.030875, -0.029921
#*# 	  -0.003996, 0.005862, 0.004619, 0.002821, 0.002799, -0.001659, 0.001554, 0.001366, -0.002114, 0.000785, -0.006307, -0.002390, -0.001500, 0.001590, -0.013400, -0.005442, -0.016759, -0.013831, -0.011551, -0.010619, -0.005598, -0.014115, -0.008303, -0.016840, -0.017369, -0.019815, -0.016380, -0.017461, -0.030136, -0.029287
#*# 	  -0.005347, 0.011974, 0.007908, 0.008555, 0.002446, -0.008102, -0.005757, -0.008857, -0.010818, -0.007348, -0.003412, -0.010730, -0.010535, -0.012274, -0.021567, -0.013516, -0.018379, -0.013186, -0.011759, -0.012529, -0.013140, -0.013032, -0.013540, -0.018006, -0.015964, -0.021405, -0.022367, -0.030899, -0.028710, -0.031199
#*# 	  -0.005432, 0.009192, 0.009142, 0.001304, 0.004649, -0.003348, -0.007713, -0.002908, -0.006980, -0.001287, -0.004694, 0.000282, -0.007215, -0.005914, -0.013274, -0.016550, -0.015362, -0.016831, -0.017237, -0.010159, -0.011436, -0.011366, -0.011911, -0.016077, -0.018518, -0.016465, -0.020676, -0.016359, -0.026870, -0.021294
#*# 	  -0.002944, 0.003326, 0.009862, 0.004313, 0.003329, -0.000096, -0.007204, -0.007742, -0.012444, -0.002955, -0.007757, -0.008355, -0.005618, -0.013646, -0.017159, -0.014454, -0.018258, -0.020583, -0.009515, -0.014689, -0.013600, -0.013608, -0.012403, -0.013369, -0.017664, -0.015705, -0.016466, -0.020813, -0.020886, -0.023842
#*# 	  0.005664, 0.010453, 0.016546, 0.006998, 0.009116, -0.002759, -0.009124, -0.007328, -0.010878, -0.006929, -0.004829, -0.006599, -0.005761, -0.006241, -0.012141, -0.013734, -0.012457, -0.009931, -0.014945, -0.011111, -0.009180, -0.011508, -0.005620, -0.006407, -0.010682, -0.011508, -0.008651, -0.016359, -0.009663, -0.011502
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 15
#*# mesh_y_pps = 15
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 155.0
#*# min_y = 25.0
#*# max_y = 155.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 82.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 85.4
