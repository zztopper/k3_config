
#####################################################################
#  MCU definition
#####################################################################
[mcu]
##	MCU motor slots
##	[X in MOTOR0] - X Motor
##	[X1 in MOTOR1] - X1 Motor
##	[Y in MOTOR2] - Y Motor
##	[Y1 in MOTOR3] - Y1 Motor
##	[Z in MOTOR4] -  Left
##	[Z1 in MOTOR5] - Rear
##	[Z2 in MOTOR6] - Right
##  [E in MOTOR7] - Extruder

##--------------------------------------------------------------------
## USB: 
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_310040001150334636383920-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_250028001551303531313638-if00
## TTYS0
#serial: /dev/ttyS0
restart_method: command
baud: 2000000

[force_move]
enable_force_move: True

#####################################################################
#  General Printer definition
#####################################################################
[printer]
kinematics: cartesian
max_velocity: 1000
#max_accel: 100000 # change this to 7500 after commissioning
#max_accel_to_decel: 100000
#square_corner_velocity: 80
max_accel: 30000
max_accel_to_decel: 30000
square_corner_velocity: 15 # start at 8, but then increase once you're sure assembly is sound
max_z_velocity: 50   # may be able to increase to 15 after comissioning.
max_z_accel: 2000


#####################################################################
#  TradRack Beta
#####################################################################
#[include trad_rack_ercf_easybrd.cfg]
#[include trad_rack_optional.cfg]

[include wled.cfg]
#####################################################################
# Pins definitions
#####################################################################
[include pins.cfg]

#####################################################################
#  Stepper Settings
#####################################################################
[include stepper.cfg]

#####################################################################
#  TMC Settings
#####################################################################
[include tmc.cfg]
#####################################################################
#  ERCF Runout Sensor
#####################################################################
# [include runout.cfg]

#####################################################################
#  Extruder & Bed
#####################################################################
#[heaters_extra]
#[pid_calibrate_extra]

[include heater.cfg]

# PID Calibrate Extra


#####################################################################
#  Annex magprobe
#####################################################################
#[include annex_probe.cfg]

#####################################################################
#  Chinese Beacon clone probe
#####################################################################
[include cartographer.cfg]

#####################################################################
#  Fan Control & extra Thermistor
#####################################################################
[include fan.cfg]


#####################################################################
#  Bed Mesh 
#####################################################################
[include bed_mesh.cfg]


#####################################################################
#  Z Tilt
#####################################################################
[include z_tilt.cfg]


#####################################################################
#  Homing Routines
#####################################################################
[include homing.cfg]


#####################################################################
#  Parking Routines
#####################################################################
[include parking.cfg]



#####################################################################
#  Heater Verification (default values)
#####################################################################
[include heater_verify.cfg]


######################################################################
#  Resonance compensation
######################################################################
[include input_shaper.cfg]
[include vibrations.cfg]

#####################################################################
#  Macros
#####################################################################
[include macro.cfg]
[include filament.cfg]

#####################################################################
#  moonraker/mainsail
##################################################################### 
[include webclient.cfg]

#####################################################################
#  LCD Effects plugin
##################################################################### 
#[include caselight.cfg]
#[include lcd_effect.cfg]

#####################################################################
# Runcam Webcam relay
##################################################################### 
#[include runcam.cfg]

#####################################################################
# Exclude objects
##################################################################### 
[include exclude.cfg]


#####################################################################
#  Idle Timeout 
#####################################################################
[idle_timeout]
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      {action_respond_info("POWER: Execute Idle Timeout")}
      TURN_OFF_HEATERS
      M107
      M84
      LIGHTS_OFF
    {% endif %}
  {% endif %}
# 2h timeout
timeout: 14400

[delayed_gcode STARTUP]
initial_duration: 3
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=multistep_filt VALUE=0
  WLED_ON PRESET=1
  {% if 'filament_motion_sensor runout' in printer.configfile.settings %}
    SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
  {% endif %}

#####################################################################
#  Speed Test GCode macros
#####################################################################
[include speedtest.cfg]

[gcode_macro SET_FIRST_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt + 2 %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt + 2%}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}

[gcode_macro SET_NORMAL_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt %}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}


#####################################################################
#  File location of stored varibales
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.208
#*# pid_ki = 1.737
#*# pid_kd = 71.557
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 47.300
#*# pid_ki = 0.542
#*# pid_kd = 1547.432
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3000
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.3875308825551953,
#*# 	  1.7278202631568433,
#*# 	  0.7838893235370594,
#*# 	  0.24874293987264537,
#*# 	  0.34521434077244983,
#*# 	  0.8075562558630205,
#*# 	  -0.17461338529613452,
#*# 	  -0.8366473192046732,
#*# 	  0.3071277074702737,
#*# 	  0.5037155047982425
#*# model_domain = 3.1315999811333346e-07,3.329880252063844e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 73.942832
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.010612, -0.007114, -0.005131, -0.007625, -0.013886, -0.006973, 0.007156, -0.002161, 0.016261, 0.013427, 0.003523, 0.019421, 0.020693, 0.017484, 0.024147, 0.020287, 0.029367, 0.023786, 0.015387, 0.020795
#*# 	  -0.029413, -0.012126, 0.000655, -0.008059, 0.003374, 0.003807, 0.001436, 0.006168, 0.022443, 0.018174, 0.020982, 0.034201, 0.041865, 0.024713, 0.038231, 0.036569, 0.035117, 0.030259, 0.028583, 0.029155
#*# 	  -0.021558, -0.015777, -0.004819, -0.007518, -0.001048, 0.004845, -0.000556, 0.010110, 0.016475, 0.011351, 0.024101, 0.023334, 0.039159, 0.042089, 0.028770, 0.040471, 0.032743, 0.035812, 0.025856, 0.028770
#*# 	  -0.044111, -0.031554, -0.015328, -0.009211, -0.003587, -0.003688, 0.005766, 0.009253, 0.005717, 0.011153, 0.022911, 0.028635, 0.025617, 0.044996, 0.034551, 0.028885, 0.045104, 0.033422, 0.031930, 0.026795
#*# 	  -0.043202, -0.027965, -0.012920, -0.005581, 0.007788, -0.001482, 0.005677, 0.014166, 0.000790, 0.014670, 0.010699, 0.026172, 0.026354, 0.027891, 0.049125, 0.028181, 0.038535, 0.035764, 0.029566, 0.029824
#*# 	  -0.054581, -0.037778, -0.010855, -0.010195, 0.007140, 0.010949, 0.005341, 0.023164, 0.010231, 0.013345, 0.010243, 0.017297, 0.034877, 0.031396, 0.035108, 0.042320, 0.033232, 0.037753, 0.028989, 0.021052
#*# 	  -0.053588, -0.047856, -0.018500, 0.007166, 0.009303, 0.018266, 0.035909, 0.031871, 0.014961, 0.009933, 0.001513, 0.006164, 0.017080, 0.029122, 0.026652, 0.031292, 0.022614, 0.031032, 0.025836, 0.020884
#*# 	  -0.056333, -0.042891, -0.015462, 0.008516, 0.044613, 0.048748, 0.054328, 0.053967, 0.023111, 0.016714, 0.015367, 0.003470, 0.013468, 0.016213, 0.028630, 0.030504, 0.024840, 0.021234, 0.019903, 0.014750
#*# 	  -0.068988, -0.037290, -0.001491, 0.025865, 0.063840, 0.080758, 0.072797, 0.062453, 0.036682, 0.022084, 0.002366, 0.008398, 0.010850, 0.015537, 0.030357, 0.016902, 0.022149, 0.024040, 0.015022, 0.012179
#*# 	  -0.085530, -0.044515, 0.001954, 0.023743, 0.071613, 0.091933, 0.081958, 0.058502, 0.040713, 0.005447, -0.001706, -0.001951, -0.007921, 0.007122, 0.009361, 0.013440, 0.011111, 0.017492, 0.010736, 0.001541
#*# 	  -0.065232, -0.066905, -0.023890, 0.021214, 0.047835, 0.073860, 0.083367, 0.061794, 0.030025, 0.000729, -0.002435, -0.021011, 0.003123, 0.009300, 0.008379, 0.011730, 0.008244, 0.012252, 0.008679, 0.007648
#*# 	  -0.071832, -0.068400, -0.027691, -0.004289, 0.035557, 0.059707, 0.045592, 0.033251, 0.026379, 0.001034, -0.018752, -0.013018, -0.007149, -0.002414, 0.008356, 0.009856, 0.009481, 0.013250, 0.005994, 0.007283
#*# 	  -0.101518, -0.063613, -0.048317, -0.020269, 0.003835, 0.024599, 0.018156, 0.018041, 0.010275, -0.010845, -0.019162, -0.024196, -0.007720, 0.003661, 0.001312, 0.020179, 0.000312, 0.008760, 0.007563, 0.003109
#*# 	  -0.102191, -0.073723, -0.050918, -0.038673, -0.024949, -0.015095, -0.011360, -0.010032, -0.014039, -0.025289, -0.025495, -0.012932, -0.017250, 0.002510, 0.007859, 0.006421, 0.006886, 0.017141, 0.003505, -0.000800
#*# 	  -0.085030, -0.079845, -0.061705, -0.053649, -0.039090, -0.044806, -0.030499, -0.022224, -0.038665, -0.030803, -0.029931, -0.028951, -0.000574, 0.000994, 0.009638, 0.010352, 0.003032, 0.009626, 0.009035, 0.008691
#*# 	  -0.092684, -0.087532, -0.076970, -0.072010, -0.057212, -0.050778, -0.042560, -0.041379, -0.047448, -0.052031, -0.051111, -0.039266, -0.023670, -0.001877, -0.017372, 0.007304, -0.000818, 0.003446, 0.000236, 0.002588
#*# 	  -0.115566, -0.087894, -0.083631, -0.076104, -0.069317, -0.060872, -0.061337, -0.047112, -0.070986, -0.061316, -0.047928, -0.040539, -0.033839, -0.014937, -0.022058, -0.007597, 0.000492, -0.002603, -0.003352, -0.001545
#*# 	  -0.112650, -0.106192, -0.076484, -0.088853, -0.084947, -0.071545, -0.065741, -0.057290, -0.063393, -0.060262, -0.050876, -0.054184, -0.036122, -0.029650, -0.026359, -0.014449, -0.021967, -0.003063, 0.000036, -0.002548
#*# 	  -0.110813, -0.107422, -0.085329, -0.098109, -0.085413, -0.079540, -0.067242, -0.069484, -0.069649, -0.061972, -0.072968, -0.051979, -0.045349, -0.026008, -0.029245, -0.018322, -0.015503, -0.011386, -0.001182, -0.003432
#*# 	  0.078364, -0.038629, 0.011653, -0.009766, -0.003087, -0.007347, -0.013157, -0.004087, -0.020775, -0.014097, -0.017118, -0.013096, -0.002330, -0.002314, -0.007258, 0.012356, 0.012877, 0.018269, 0.035699, 0.026969
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 15
#*# mesh_y_pps = 15
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 155.0
#*# min_y = 25.0
#*# max_y = 155.0
