
#####################################################################
#  MCU definition
#####################################################################
[mcu]
##	MCU motor slots
##	[X in MOTOR0] - X Motor
##	[X1 in MOTOR1] - X1 Motor
##	[Y in MOTOR2] - Y Motor
##	[Y1 in MOTOR3] - Y1 Motor
##	[Z in MOTOR4] -  Left
##	[Z1 in MOTOR5] - Rear
##	[Z2 in MOTOR6] - Right
##  [E in MOTOR7] - Extruder

##--------------------------------------------------------------------
## USB: 
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_310040001150334636383920-if00
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_250028001551303531313638-if00
## TTYS0
#serial: /dev/ttyS0
restart_method: command
baud: 2000000

[force_move]
enable_force_move: True

#####################################################################
#  General Printer definition
#####################################################################
[printer]
kinematics: cartesian
max_velocity: 1000
#max_accel: 100000 # change this to 7500 after commissioning
#max_accel_to_decel: 100000
#square_corner_velocity: 80
max_accel: 30000
square_corner_velocity: 15 # start at 8, but then increase once you're sure assembly is sound
max_z_velocity: 50   # may be able to increase to 15 after comissioning.
max_z_accel: 2000


#####################################################################
#  TradRack Beta
#####################################################################
#[include trad_rack_ercf_easybrd.cfg]
#[include trad_rack_optional.cfg]

[include wled.cfg]
#####################################################################
# Pins definitions
#####################################################################
[include pins.cfg]

#####################################################################
#  Stepper Settings
#####################################################################
[include stepper.cfg]

#####################################################################
#  TMC Settings
#####################################################################
[include tmc.cfg]
#####################################################################
#  ERCF Runout Sensor
#####################################################################
# [include runout.cfg]

#####################################################################
#  Extruder & Bed
#####################################################################
#[heaters_extra]
#[pid_calibrate_extra]

[include heater.cfg]

# PID Calibrate Extra


#####################################################################
#  Annex magprobe
#####################################################################
#[include annex_probe.cfg]

#####################################################################
#  Chinese Beacon clone probe
#####################################################################
[include cartographer.cfg]

#####################################################################
#  Fan Control & extra Thermistor
#####################################################################
[include fan.cfg]


#####################################################################
#  Bed Mesh 
#####################################################################
[include bed_mesh.cfg]


#####################################################################
#  Z Tilt
#####################################################################
[include z_tilt.cfg]


#####################################################################
#  Homing Routines
#####################################################################
[include homing.cfg]


#####################################################################
#  Parking Routines
#####################################################################
[include parking.cfg]



#####################################################################
#  Heater Verification (default values)
#####################################################################
[include heater_verify.cfg]


######################################################################
#  Resonance compensation
######################################################################
[include input_shaper.cfg]
[include vibrations.cfg]

#####################################################################
#  Macros
#####################################################################
[include macro.cfg]
[include filament.cfg]

#####################################################################
#  moonraker/mainsail
##################################################################### 
[include webclient.cfg]

#####################################################################
#  LCD Effects plugin
##################################################################### 
#[include caselight.cfg]
#[include lcd_effect.cfg]

#####################################################################
# Runcam Webcam relay
##################################################################### 
#[include runcam.cfg]

#####################################################################
# Exclude objects
##################################################################### 
[include exclude.cfg]


#####################################################################
#  Idle Timeout 
#####################################################################
[idle_timeout]
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      {action_respond_info("POWER: Execute Idle Timeout")}
      TURN_OFF_HEATERS
      M107
      M84
      LIGHTS_OFF
    {% endif %}
  {% endif %}
# 2h timeout
timeout: 14400

[delayed_gcode STARTUP]
initial_duration: 3
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=multistep_filt VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=multistep_filt VALUE=0
  WLED_ON PRESET=1
  {% if 'filament_motion_sensor runout' in printer.configfile.settings %}
    SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
  {% endif %}

#####################################################################
#  Speed Test GCode macros
#####################################################################
[include speedtest.cfg]

[gcode_macro SET_FIRST_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt + 2 %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt + 2%}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}

[gcode_macro SET_NORMAL_SGT]
gcode: 
  {% set x_sgt  = printer.configfile.settings['tmc5160 stepper_x'].driver_sgt %}
  {% set y_sgt  = printer.configfile.settings['tmc5160 stepper_y'].driver_sgt %}
  SET_TMC_FIELD STEPPER=stepper_x FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_x1 FIELD=sgt VALUE={x_sgt}
  SET_TMC_FIELD STEPPER=stepper_y FIELD=sgt VALUE={y_sgt}
  SET_TMC_FIELD STEPPER=stepper_y1 FIELD=sgt VALUE={y_sgt}


#####################################################################
#  File location of stored varibales
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 17.332
#*# pid_ki = 1.002
#*# pid_kd = 74.961
#*# pid_version = 1
#*# pid_target = 260.00
#*# pid_tolerance = 0.0200
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 47.300
#*# pid_ki = 0.542
#*# pid_kd = 1547.432
#*#
#*# [scanner]
#*# mode = scan
#*# scanner_touch_threshold = 3000
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.2680427005900434,
#*# 	  1.6867360823843804,
#*# 	  0.735539481128375,
#*# 	  0.2697653714089986,
#*# 	  0.5681657635980129,
#*# 	  0.9790894697561997,
#*# 	  -0.5071073974758741,
#*# 	  -1.21141262142833,
#*# 	  0.4847770964578287,
#*# 	  0.7263243044028517
#*# model_domain = 3.097722107935441e-07,3.326157217241493e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 64.358046
#*# model_offset = 0.00000
#*# model_mode = scan
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.014546, 0.026856, 0.029178, 0.016935, 0.020678, 0.015543, 0.014410, 0.008879, 0.010634, 0.008419, 0.010145, 0.006205, 0.006673, 0.000986, -0.003869, -0.008144, -0.010357, -0.011750, -0.015563, -0.018545, -0.019646, -0.025228, -0.030113, -0.030334, -0.041160, -0.050527, -0.049834, -0.054832, -0.066325, -0.070744
#*# 	0.028217, 0.035855, 0.038577, 0.037585, 0.030335, 0.030633, 0.023315, 0.023955, 0.021669, 0.016629, 0.018627, 0.021437, 0.012433, 0.012363, 0.011035, 0.004749, 0.002701, -0.000046, -0.008061, -0.010961, -0.013610, -0.021026, -0.024126, -0.030931, -0.034343, -0.046500, -0.047424, -0.054350, -0.060199, -0.073764
#*# 	0.021458, 0.031978, 0.038227, 0.032944, 0.029121, 0.030472, 0.020094, 0.021706, 0.020742, 0.023614, 0.022150, 0.025957, 0.020456, 0.021855, 0.009610, 0.005358, 0.004352, 0.002378, -0.000141, -0.002733, -0.003718, -0.006580, -0.018017, -0.018409, -0.024333, -0.035518, -0.039710, -0.043847, -0.045201, -0.067937
#*# 	0.034720, 0.039848, 0.042979, 0.039798, 0.038498, 0.032437, 0.029772, 0.029703, 0.028674, 0.027301, 0.026484, 0.028127, 0.025210, 0.020659, 0.014354, 0.014665, 0.013021, 0.007818, 0.008877, 0.003781, -0.001425, -0.005271, -0.010303, -0.016087, -0.023433, -0.029166, -0.035087, -0.049317, -0.050639, -0.059918
#*# 	0.025685, 0.035242, 0.034928, 0.034843, 0.036030, 0.030789, 0.028928, 0.028454, 0.029043, 0.024765, 0.026090, 0.028728, 0.022717, 0.022604, 0.017667, 0.016026, 0.013287, 0.012146, 0.011042, 0.009137, 0.006808, 0.001769, -0.000526, -0.010099, -0.021038, -0.029006, -0.026700, -0.023572, -0.054018, -0.050713
#*# 	0.021970, 0.035380, 0.040675, 0.036692, 0.033022, 0.030958, 0.030770, 0.028249, 0.029319, 0.027603, 0.022706, 0.025953, 0.020978, 0.018354, 0.012783, 0.009694, 0.009226, 0.003865, 0.006371, 0.005511, 0.000810, 0.000211, -0.006580, -0.016784, -0.021918, -0.028854, -0.033038, -0.042466, -0.048433, -0.056659
#*# 	0.013246, 0.029809, 0.034420, 0.029806, 0.030887, 0.026015, 0.023841, 0.024569, 0.023113, 0.021372, 0.017769, 0.019718, 0.015748, 0.012025, 0.009463, 0.006843, 0.008420, 0.004870, 0.006902, 0.004564, 0.001548, 0.003497, -0.002953, -0.010839, -0.014935, -0.025372, -0.026468, -0.035323, -0.040798, -0.048426
#*# 	0.009130, 0.028016, 0.032102, 0.031768, 0.027110, 0.028020, 0.024576, 0.025724, 0.028208, 0.027365, 0.024211, 0.028249, 0.021289, 0.016793, 0.012440, 0.011731, 0.009593, 0.007767, 0.010024, 0.010636, 0.009845, 0.001410, -0.000316, -0.003661, -0.015738, -0.022039, -0.028551, -0.034450, -0.043642, -0.052162
#*# 	0.020927, 0.031330, 0.044054, 0.034421, 0.033979, 0.029340, 0.027840, 0.032403, 0.027503, 0.030461, 0.031536, 0.029336, 0.024507, 0.024804, 0.020839, 0.015891, 0.018757, 0.018373, 0.017550, 0.015208, 0.016345, 0.013924, 0.008752, 0.002386, -0.007705, -0.010889, -0.020055, -0.026359, -0.036305, -0.042014
#*# 	0.020983, 0.026378, 0.028035, 0.037676, 0.029916, 0.026814, 0.026715, 0.026229, 0.025303, 0.025812, 0.025436, 0.028746, 0.024344, 0.017423, 0.017265, 0.014919, 0.011272, 0.008101, 0.012744, 0.009199, 0.009375, 0.008547, 0.004147, -0.004556, -0.008695, -0.019701, -0.021057, -0.020641, -0.042970, -0.044554
#*# 	0.006934, 0.020715, 0.023707, 0.022620, 0.021026, 0.017782, 0.014226, 0.018810, 0.017194, 0.017394, 0.019295, 0.019980, 0.011519, 0.008598, 0.009491, 0.005474, 0.006183, 0.005686, 0.008341, 0.007338, 0.008197, 0.006552, 0.000639, -0.001350, -0.007208, -0.010060, -0.014937, -0.030053, -0.027613, -0.036948
#*# 	0.011349, 0.021435, 0.026696, 0.026307, 0.023818, 0.022227, 0.014536, 0.020487, 0.022488, 0.016873, 0.020008, 0.020343, 0.014773, 0.017148, 0.010135, 0.008186, 0.007338, 0.005320, 0.000956, 0.004418, 0.006463, 0.000959, -0.002714, -0.010911, -0.010593, -0.019370, -0.024173, -0.027816, -0.030628, -0.050514
#*# 	0.003665, 0.018844, 0.021818, 0.018341, 0.018563, 0.014002, 0.012340, 0.017495, 0.013295, 0.017510, 0.013786, 0.013310, 0.007238, 0.007188, 0.004066, 0.001215, 0.001664, 0.001164, -0.002570, -0.002608, 0.000239, -0.006118, -0.007919, -0.011268, -0.019901, -0.025720, -0.027019, -0.029746, -0.032880, -0.046434
#*# 	0.012287, 0.020194, 0.029917, 0.019977, 0.024171, 0.020576, 0.017402, 0.017680, 0.017266, 0.017346, 0.013576, 0.015147, 0.009615, 0.010702, 0.006128, 0.002507, 0.005652, 0.000197, -0.000207, -0.001919, -0.001148, -0.003613, -0.006037, -0.010817, -0.013574, -0.023540, -0.024922, -0.033069, -0.038127, -0.045035
#*# 	0.001262, 0.013966, 0.013578, 0.014776, 0.012372, 0.010671, 0.009480, 0.010773, 0.010648, 0.009786, 0.009175, 0.008328, 0.007325, 0.003663, 0.001745, 0.000587, 0.000539, -0.002030, -0.002787, -0.000012, 0.000119, -0.005587, -0.009277, -0.012146, -0.014619, -0.022070, -0.019831, -0.010546, -0.043295, -0.030332
#*# 	0.005492, 0.013881, 0.017468, 0.018654, 0.016411, 0.013601, 0.012289, 0.011112, 0.009468, 0.012266, 0.010184, 0.007851, 0.005413, 0.001311, 0.003781, -0.001362, -0.003227, -0.004555, -0.008781, -0.009912, -0.009794, -0.011563, -0.012489, -0.022147, -0.019619, -0.026956, -0.029804, -0.034789, -0.042657, -0.042917
#*# 	-0.002301, 0.012616, 0.022344, 0.016650, 0.014781, 0.012910, 0.009281, 0.011166, 0.012329, 0.010876, 0.010155, 0.007721, 0.007726, -0.000132, 0.001313, -0.002771, -0.006329, -0.002994, -0.008203, -0.011253, -0.008541, -0.009984, -0.012385, -0.019991, -0.021183, -0.026837, -0.027055, -0.027387, -0.037797, -0.042856
#*# 	0.006719, 0.018582, 0.024210, 0.023297, 0.016680, 0.014000, 0.016776, 0.015669, 0.010831, 0.012717, 0.009592, 0.010697, 0.008869, 0.004439, -0.000627, 0.001640, -0.001578, -0.005025, -0.006656, -0.004742, -0.005929, -0.007569, -0.010613, -0.015416, -0.015827, -0.022099, -0.021252, -0.025227, -0.031161, -0.036075
#*# 	0.001445, 0.015563, 0.018359, 0.014247, 0.015827, 0.012929, 0.008404, 0.012260, 0.008669, 0.012285, 0.011341, 0.008760, 0.003547, 0.004357, 0.002463, -0.000370, 0.000258, -0.004910, -0.000331, -0.000512, 0.000191, -0.000192, -0.003981, -0.005357, -0.007688, -0.008079, -0.011754, -0.017295, -0.013649, -0.032215
#*# 	0.012643, 0.016629, 0.021872, 0.019813, 0.019396, 0.012940, 0.013138, 0.016105, 0.013660, 0.013995, 0.018570, 0.011356, 0.007967, 0.008406, 0.003730, 0.000950, -0.000942, -0.001862, -0.000603, 0.001204, 0.003695, -0.000972, 0.000187, -0.003580, -0.006186, -0.012975, -0.013567, -0.015155, -0.024202, -0.028653
#*# 	0.011590, 0.017189, 0.026342, 0.023866, 0.024474, 0.015169, 0.013011, 0.017566, 0.010843, 0.013654, 0.013099, 0.011842, 0.012009, 0.009125, 0.006875, 0.000910, -0.000314, -0.002469, -0.001708, 0.006162, 0.004317, 0.004510, 0.001140, -0.000810, -0.003266, -0.006958, -0.007932, -0.016138, -0.020761, -0.024479
#*# 	0.008410, 0.017431, 0.019805, 0.016929, 0.013383, 0.016743, 0.010642, 0.010909, 0.007436, 0.013434, 0.010384, 0.011026, 0.008545, 0.004611, -0.003391, -0.004100, -0.006912, -0.003193, -0.007354, -0.001359, 0.003727, 0.001800, -0.002166, -0.002464, -0.002352, -0.004978, -0.007568, -0.014467, -0.011829, -0.032209
#*# 	0.005458, 0.014706, 0.021437, 0.018738, 0.018857, 0.012780, 0.013412, 0.017040, 0.013542, 0.014209, 0.014873, 0.012069, 0.007645, 0.007872, 0.002295, -0.002642, -0.003163, -0.002459, -0.004484, -0.002306, 0.005307, 0.005382, 0.002676, 0.002413, -0.000117, -0.000076, -0.005737, -0.006942, -0.013688, -0.019681
#*# 	-0.008803, 0.011914, 0.014633, 0.017908, 0.010438, 0.005693, 0.007096, 0.008916, 0.008078, 0.007126, 0.010337, 0.008082, 0.003149, -0.005129, -0.005714, -0.008307, -0.011761, -0.012493, -0.012854, -0.006039, -0.001409, -0.000870, 0.000072, -0.001817, -0.002590, -0.004325, -0.009373, -0.011082, -0.017692, -0.024791
#*# 	0.002228, 0.015165, 0.017407, 0.015001, 0.013538, 0.008333, 0.008620, 0.009401, 0.010145, 0.011189, 0.008304, 0.006698, 0.003220, -0.001713, -0.005864, -0.008359, -0.007064, -0.011715, -0.009852, -0.006879, 0.000072, 0.000681, -0.004216, -0.008721, -0.006614, -0.012562, -0.013968, -0.015338, -0.030821, -0.012207
#*# 	-0.001672, 0.003950, 0.012757, 0.007435, 0.007539, 0.004979, 0.000020, 0.001414, -0.004577, 0.000046, 0.001016, 0.001082, -0.005919, -0.009523, -0.013656, -0.021637, -0.020199, -0.019448, -0.018548, -0.018956, -0.012667, -0.008762, -0.013096, -0.016201, -0.018197, -0.018956, -0.022843, -0.016377, -0.031256, -0.030239
#*# 	-0.000144, 0.015455, 0.016979, 0.013643, 0.014253, 0.009635, 0.006163, 0.008412, 0.010214, 0.013167, 0.007654, 0.007361, 0.000847, -0.002528, -0.011468, -0.010829, -0.008958, -0.010789, -0.013072, -0.009544, -0.003412, -0.006783, -0.008067, -0.010145, -0.005529, -0.012824, -0.016012, -0.012205, -0.016738, -0.025382
#*# 	-0.010850, -0.003065, 0.001863, -0.003747, -0.000138, -0.009476, -0.007480, -0.006308, -0.008929, -0.002748, -0.003965, -0.011529, -0.010920, -0.016232, -0.022054, -0.025153, -0.026511, -0.025906, -0.021038, -0.024208, -0.020722, -0.019534, -0.020289, -0.020211, -0.024252, -0.022174, -0.027183, -0.024385, -0.025554, -0.027913
#*# 	-0.013703, -0.000537, -0.001713, -0.001878, -0.004650, -0.008111, -0.006813, -0.005670, -0.005607, -0.001225, -0.005804, -0.002041, -0.008435, -0.015968, -0.019910, -0.018389, -0.019657, -0.016624, -0.018875, -0.013581, -0.012225, -0.015195, -0.013023, -0.012797, -0.015215, -0.014333, -0.017544, -0.014594, -0.017619, -0.024563
#*# 	-0.015938, -0.003365, 0.001847, -0.005173, -0.006097, -0.011969, -0.013933, -0.012264, -0.017004, -0.013407, -0.011781, -0.011942, -0.017688, -0.021601, -0.027281, -0.030057, -0.031274, -0.032652, -0.027301, -0.020784, -0.023016, -0.020618, -0.022296, -0.024220, -0.027523, -0.026052, -0.027862, -0.030202, -0.031204, -0.029820
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 15
#*# mesh_y_pps = 15
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 155.0
#*# min_y = 25.0
#*# max_y = 155.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 82.0
#*# shaper_type_y = zv
#*# shaper_freq_y = 85.4
